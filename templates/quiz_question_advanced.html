{% extends "base.html" %}

{% block title %}Quiz Question {{ question_num }} - Educational Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Question {{ question_num }} of {{ total_questions }}</h5>
                <div class="progress" style="width: 200px; height: 8px;">
                    <div class="progress-bar" style="width: {{ (question_num / total_questions) * 100 }}%"></div>
                </div>
            </div>
            <div class="card-body">
                <h6 class="card-title">{{ question.question_text }}</h6>
                
                {% if question.question_type == 'multiple_choice' %}
                <div class="quiz-options mt-4">
                    {% for option in question.get_options() %}
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="answer" value="{{ option }}" id="option{{ loop.index }}">
                        <label class="form-check-label" for="option{{ loop.index }}">
                            {{ option }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% elif question.question_type == 'true_false' %}
                <div class="quiz-options mt-4">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="answer" value="True" id="true">
                        <label class="form-check-label" for="true">True</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="answer" value="False" id="false">
                        <label class="form-check-label" for="false">False</label>
                    </div>
                </div>
                {% else %}
                <div class="mt-4">
                    <textarea class="form-control" name="answer" rows="4" placeholder="Enter your answer here..."></textarea>
                </div>
                {% endif %}

                <div class="mt-4 d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-info" onclick="getHint()">
                        <i class="fas fa-lightbulb"></i> Get Hint
                    </button>
                    <div>
                        {% if question_num > 1 %}
                        <a href="{{ url_for('quiz_question', question_num=question_num-1) }}" class="btn btn-secondary">Previous</a>
                        {% endif %}
                        <button type="button" class="btn btn-primary" onclick="submitAnswer()">
                            {% if question_num == total_questions %}Finish{% else %}Next{% endif %}
                        </button>
                    </div>
                </div>

                <div id="hint-container" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Hint:</strong> <span id="hint-text"></span>
                    </div>
                </div>

                <div id="feedback-container" class="mt-3" style="display: none;">
                    <div class="alert" id="feedback-alert">
                        <span id="feedback-text"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let startTime = Date.now();
let hintsUsed = 0;

function getHint() {
    hintsUsed++;
    fetch(`/quiz/hint/{{ question.id }}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('hint-text').textContent = data.hint;
            document.getElementById('hint-container').style.display = 'block';
        });
}

function submitAnswer() {
    const selectedAnswer = document.querySelector('input[name="answer"]:checked') || document.querySelector('textarea[name="answer"]');
    
    if (!selectedAnswer || !selectedAnswer.value) {
        alert('Please select or enter an answer');
        return;
    }

    const responseTime = Math.floor((Date.now() - startTime) / 1000);
    
    fetch('/quiz/submit_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: {{ question.id }},
            answer: selectedAnswer.value,
            response_time: responseTime,
            hints_used: hintsUsed
        })
    })
    .then(response => response.json())
    .then(data => {
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackAlert = document.getElementById('feedback-alert');
        const feedbackText = document.getElementById('feedback-text');
        
        if (data.correct) {
            feedbackAlert.className = 'alert alert-success';
            feedbackText.innerHTML = '<i class="fas fa-check"></i> Correct!';
        } else {
            feedbackAlert.className = 'alert alert-danger';
            feedbackText.innerHTML = `<i class="fas fa-times"></i> Incorrect. ${data.explanation || ''}`;
        }
        
        feedbackContainer.style.display = 'block';
        
        // Move to next question after delay
        setTimeout(() => {
            {% if question_num == total_questions %}
                window.location.href = '{{ url_for("quiz_complete") }}';
            {% else %}
                window.location.href = '{{ url_for("quiz_question", question_num=question_num+1) }}';
            {% endif %}
        }, 2000);
    });
}
</script>
{% endblock %}