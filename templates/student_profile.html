<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile - {{ student.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .analytics-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .recommendation-item {
            border-left: 4px solid #007bff;
            background: white;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .performance-metric {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .progress-ring {
            width: 120px;
            height: 120px;
            transform: rotate(-90deg);
        }
        .progress-ring__circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        .category-badge {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
        }
        .struggling { background-color: #dc3545; color: white; }
        .average { background-color: #ffc107; color: black; }
        .advanced { background-color: #28a745; color: white; }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-graduation-cap me-2"></i>EduPlatform
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
                <a class="nav-link active" href="{{ url_for('view_progress') }}">Profile</a>
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-user-circle fa-3x"></i>
                        </div>
                        <div>
                            <h2 class="mb-1">{{ student.name }}</h2>
                            <p class="mb-1">Student ID: {{ student.student_id }} â€¢ Class: {{ student.class_name }}</p>
                            <p class="mb-0 opacity-75">Member since {{ student.created_at.strftime('%B %Y') }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    {% if profile.predicted_category %}
                    <div class="mb-2">
                        <span class="badge category-badge {{ profile.predicted_category }}">
                            {% if profile.predicted_category == 'struggling' %}
                                <i class="fas fa-hand-holding-heart me-1"></i>Needs Support
                            {% elif profile.predicted_category == 'advanced' %}
                                <i class="fas fa-rocket me-1"></i>Advanced Learner
                            {% else %}
                                <i class="fas fa-balance-scale me-1"></i>On Track
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                    <div class="opacity-75">
                        Last updated: {{ profile.updated_at.strftime('%m/%d/%Y') if profile.updated_at else 'Never' }}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Performance Analytics -->
            <div class="col-lg-8">
                <div class="analytics-card">
                    <h4><i class="fas fa-chart-line me-2"></i>Learning Analytics</h4>
                    
                    <!-- Key Metrics -->
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="performance-metric">
                                <div class="metric-value">{{ "%.1f" | format(profile.average_score or 0) }}</div>
                                <small class="text-muted">Average Score</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="performance-metric">
                                <div class="metric-value">{{ profile.total_quizzes_completed or 0 }}</div>
                                <small class="text-muted">Quizzes Completed</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="performance-metric">
                                <div class="metric-value text-success">
                                    {% if profile.improvement_rate and profile.improvement_rate > 0 %}+{% endif %}
                                    {{ "%.1f" | format(profile.improvement_rate or 0) }}%
                                </div>
                                <small class="text-muted">Improvement Rate</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="performance-metric">
                                <div class="metric-value">
                                    {{ "%.0f" | format((profile.confidence_level or 0.5) * 100) }}%
                                </div>
                                <small class="text-muted">AI Confidence</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Trends Chart -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-area me-2"></i>Performance Trends</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>Recent Quiz Activity</h5>
                    </div>
                    <div class="card-body">
                        {% if recent_attempts %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Quiz Topic</th>
                                        <th>Score</th>
                                        <th>Predicted Score</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attempt in recent_attempts %}
                                    <tr>
                                        <td>
                                            <strong>{{ attempt.quiz.topic.name }}</strong><br>
                                            <small class="text-muted">{{ attempt.quiz.title }}</small>
                                        </td>
                                        <td>
                                            <span class="badge {% if attempt.score >= 80 %}bg-success{% elif attempt.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ "%.0f" | format(attempt.score or 0) }}%
                                            </span>
                                        </td>
                                        <td>
                                            {% set prediction = attempt.ml_prediction %}
                                            {% if prediction %}
                                                {{ "%.0f" | format(prediction.predicted_score) }}%
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ attempt.completed_at.strftime('%m/%d/%Y') if attempt.completed_at else 'In Progress' }}</td>
                                        <td>
                                            {% if attempt.completed_at %}
                                            <a href="{{ url_for('quiz_results', attempt_id=attempt.id) }}" class="btn btn-sm btn-outline-primary">
                                                View Results
                                            </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                            <p>No quiz attempts yet. <a href="{{ url_for('quiz_selection') }}">Take your first quiz!</a></p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Recommendations Sidebar -->
            <div class="col-lg-4">
                <!-- Active Recommendations -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-lightbulb me-2"></i>Personalized Recommendations</h5>
                    </div>
                    <div class="card-body">
                        {% if recommendations %}
                            {% for rec in recommendations %}
                            <div class="recommendation-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ rec.title }}</h6>
                                        <p class="mb-2 small text-muted">{{ rec.description }}</p>
                                        <div class="d-flex align-items-center">
                                            {% if rec.recommendation_type == 'quiz_difficulty' %}
                                                <span class="badge bg-primary me-2">Quiz Level</span>
                                            {% elif rec.recommendation_type == 'study_material' %}
                                                <span class="badge bg-info me-2">Study Guide</span>
                                            {% elif rec.recommendation_type == 'focus_area' %}
                                                <span class="badge bg-warning text-dark me-2">Focus Area</span>
                                            {% elif rec.recommendation_type == 'hint_settings' %}
                                                <span class="badge bg-secondary me-2">Settings</span>
                                            {% endif %}
                                            <small class="text-muted">
                                                Priority: {% if rec.priority == 1 %}High{% elif rec.priority == 2 %}Medium{% else %}Low{% endif %}
                                            </small>
                                        </div>
                                    </div>
                                    <form method="POST" action="{{ url_for('complete_recommendation', rec_id=rec.id) }}" class="ms-2">
                                        <button type="submit" class="btn btn-sm btn-outline-success" title="Mark as completed">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-robot fa-2x mb-2"></i>
                                <p>Complete a quiz to get personalized recommendations!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Learning Profile -->
                {% if profile.learner_profile_json %}
                {% set learner_profile = profile.learner_profile_json | safe | from_json %}
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-user-cog me-2"></i>Learning Profile</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">SUPPORT NEEDED</label>
                            <div class="mt-1">
                                {% if learner_profile.support_needed == 'high' %}
                                    <span class="badge bg-danger">High Support</span>
                                    <small class="text-muted d-block">You benefit from extra guidance</small>
                                {% elif learner_profile.support_needed == 'low' %}
                                    <span class="badge bg-success">Independent</span>
                                    <small class="text-muted d-block">You work well on your own</small>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Moderate Support</span>
                                    <small class="text-muted d-block">You do well with some guidance</small>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">LEARNING PACE</label>
                            <div class="mt-1">
                                {% if learner_profile.learning_pace == 'fast' %}
                                    <span class="badge bg-success">Fast Learner</span>
                                    <small class="text-muted d-block">You grasp concepts quickly</small>
                                {% elif learner_profile.learning_pace == 'deliberate' %}
                                    <span class="badge bg-info">Thoughtful</span>
                                    <small class="text-muted d-block">You take time to understand deeply</small>
                                {% else %}
                                    <span class="badge bg-secondary">Steady</span>
                                    <small class="text-muted d-block">You learn at a consistent pace</small>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <label class="small fw-bold text-muted">PROBLEM SOLVING</label>
                            <div class="mt-1">
                                {% if learner_profile.problem_solving == 'efficient' %}
                                    <span class="badge bg-success">Efficient</span>
                                    <small class="text-muted d-block">You solve problems effectively</small>
                                {% elif learner_profile.problem_solving == 'needs_practice' %}
                                    <span class="badge bg-warning text-dark">Needs Practice</span>
                                    <small class="text-muted d-block">Focus on problem-solving skills</small>
                                {% else %}
                                    <span class="badge bg-secondary">Developing</span>
                                    <small class="text-muted d-block">Your skills are improving</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Quick Actions -->
                <div class="card mt-3">
                    <div class="card-body text-center">
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('quiz_selection') }}" class="btn btn-primary">
                                <i class="fas fa-play me-2"></i>Take New Quiz
                            </a>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-info">
                                <i class="fas fa-home me-2"></i>Back to Dashboard
                            </a>
                            <button class="btn btn-outline-secondary" onclick="loadAnalyticsDashboard()">
                                <i class="fas fa-chart-bar me-2"></i>Advanced Analytics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Analytics Modal -->
    <div class="modal fade" id="analyticsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i>Advanced Learning Analytics
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Performance vs Prediction</div>
                                <div class="card-body">
                                    <canvas id="comparisonChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Learning Style Analysis</div>
                                <div class="card-body">
                                    <canvas id="learningStyleChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">Improvement Areas</div>
                                <div class="card-body">
                                    <div id="improvementAreas"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Performance Trends Chart
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        // Prepare data from server
        const performanceData = {
            labels: [
                {% for attempt in recent_attempts|reverse %}
                    '{{ attempt.completed_at.strftime("%m/%d") if attempt.completed_at }}',
                {% endfor %}
            ],
            datasets: [{
                label: 'Actual Score',
                data: [
                    {% for attempt in recent_attempts|reverse %}
                        {{ attempt.score or 0 }},
                    {% endfor %}
                ],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true
            }{% if recent_predictions %}, {
                label: 'AI Predicted Score',
                data: [
                    {% for prediction in recent_predictions|reverse %}
                        {{ prediction.predicted_score }},
                    {% endfor %}
                ],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4,
                fill: false,
                borderDash: [5, 5]
            }{% endif %}]
        };

        new Chart(ctx, {
            type: 'line',
            data: performanceData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Score Trends Over Time'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Score (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Quiz Attempts'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });

        // Advanced Analytics Functions
        async function loadAnalyticsDashboard() {
            try {
                const response = await fetch('/api/student/analytics');
                const data = await response.json();
                
                if (response.ok) {
                    updateAdvancedCharts(data);
                    const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
                    modal.show();
                } else {
                    console.error('Failed to load analytics:', data.error);
                    alert('Failed to load advanced analytics. Please try again.');
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                alert('Network error loading analytics.');
            }
        }

        function updateAdvancedCharts(data) {
            // Performance vs Prediction Comparison
            const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
            new Chart(comparisonCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Actual vs Predicted',
                        data: data.performance_trend.map(item => ({
                            x: item.predicted_score || 0,
                            y: item.score || 0
                        })),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Prediction Accuracy'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Predicted Score' },
                            min: 0, max: 100
                        },
                        y: {
                            title: { display: true, text: 'Actual Score' },
                            min: 0, max: 100
                        }
                    }
                }
            });

            // Learning Style Radar Chart
            const learningStyleCtx = document.getElementById('learningStyleChart').getContext('2d');
            const profile = data.learning_profile || {};
            
            new Chart(learningStyleCtx, {
                type: 'radar',
                data: {
                    labels: ['Problem Solving', 'Independence', 'Speed', 'Confidence', 'Persistence'],
                    datasets: [{
                        label: 'Learning Profile',
                        data: [
                            profile.problem_solving === 'efficient' ? 5 : profile.problem_solving === 'needs_practice' ? 2 : 3,
                            profile.support_needed === 'low' ? 5 : profile.support_needed === 'high' ? 2 : 3,
                            profile.learning_pace === 'fast' ? 5 : profile.learning_pace === 'deliberate' ? 2 : 3,
                            4, // Confidence placeholder
                            4  // Persistence placeholder
                        ],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 5
                        }
                    }
                }
            });

            // Update improvement areas
            const improvementDiv = document.getElementById('improvementAreas');
            const improvements = data.improvement_areas || [];
            const strengths = data.strengths || [];
            
            let html = '<div class="row">';
            
            if (improvements.length > 0) {
                html += '<div class="col-md-6"><h6 class="text-warning">Areas for Improvement</h6><ul>';
                improvements.forEach(area => {
                    html += `<li class="mb-1">${area}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (strengths.length > 0) {
                html += '<div class="col-md-6"><h6 class="text-success">Your Strengths</h6><ul>';
                strengths.forEach(strength => {
                    html += `<li class="mb-1">${strength}</li>`;
                });
                html += '</ul></div>';
            }
            
            html += '</div>';
            
            if (improvements.length === 0 && strengths.length === 0) {
                html = '<div class="text-center text-muted"><i class="fas fa-chart-line fa-2x mb-2"></i><p>Complete more quizzes to see detailed insights!</p></div>';
            }
            
            improvementDiv.innerHTML = html;
        }

        // Add some animation on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Animate metric values
            const metrics = document.querySelectorAll('.metric-value');
            metrics.forEach(metric => {
                const value = parseFloat(metric.textContent);
                if (!isNaN(value)) {
                    let current = 0;
                    const increment = value / 30;
                    const timer = setInterval(() => {
                        current += increment;
                        if (current >= value) {
                            current = value;
                            clearInterval(timer);
                        }
                        metric.textContent = current.toFixed(1);
                        if (metric.textContent.includes('%') || metric.nextElementSibling?.textContent?.includes('Score')) {
                            metric.textContent = current.toFixed(1);
                        } else {
                            metric.textContent = Math.round(current);
                        }
                    }, 50);
                }
            });
        });

        // Helper function to parse JSON (for older browsers)
        function parseJSON(str) {
            try {
                return JSON.parse(str);
            } catch (e) {
                return {};
            }
        }
    </script>
</body>
</html>